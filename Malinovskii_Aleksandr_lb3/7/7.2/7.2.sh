#!/bin/bash
# =============================================================================
# Скрипт для компиляции и запуска UDP-сервера и клиента
# =============================================================================
# Цель:
#   Компиляция и запуск UDP-сервера и клиента, а также трассировка их сетевого
#   взаимодействия с помощью `strace`. Скрипт предназначен для демонстрации
#   основных принципов работы с UDP-сокетами.
#
# Описание:
#   Скрипт выполняет следующие действия:
#     1. Компилирует исходные файлы "server.c" и "client.c" в исполняемые
#        файлы "udp_server" и "udp_client".
#     2. Запускает UDP-сервер в фоновом режиме, трассируя его системные
#        вызовы с помощью `strace`.
#     3. Запускает UDP-клиент, также трассируя его системные вызовы с помощью
#        `strace`.
#     4. Завершает работу UDP-сервера.
#
# Используемые инструменты:
#   - `gcc`: Компилятор C.
#   - `strace`: Утилита для трассировки системных вызовов.
#   - `kill`: Утилита для завершения процессов.
#   - `chmod`: Утилита для изменения прав доступа к файлам.
#
# Трассируемые системные вызовы:
#   - `sendto`: Отправка данных по UDP-сокету.
#   - `recvfrom`: Получение данных по UDP-сокету.
#   - `connect`:  Хотя UDP не требует установления соединения, в некоторых
#      реализациях может использоваться для связывания сокета с определённым
#      адресом.
#   - `accept`: Не используется в UDP.
#
# Параметры:
#   Нет. Скрипт не принимает аргументов командной строки.
#
# Зависимости:
#   - gcc
#   - strace
#
# Вывод:
#   Скрипт выводит сообщения о ходе выполнения в текущем терминале.  Подробный
#   анализ сетевого взаимодействия можно получить из вывода `strace` (в
#   терминале).
#
# Примечания:
#   - Перед запуском скрипта убедитесь, что у вас есть исходные файлы
#     "server.c" и "client.c" в текущем каталоге.
#   - Скрипт предполагает, что сервер слушает на localhost и на стандартном
#     порту (определён в коде "server.c").
#   - Обратите внимание, что UDP не гарантирует доставку сообщений.
# =============================================================================

cd 7/7.2
echo "=============================================="
echo "                  ЗАДАНИЕ 7.2                 "
echo "=============================================="
# Компиляция
gcc server.c -o udp_server
gcc client.c -o udp_client
chmod +x udp_server udp_client

# Запуск сервера в фоне
strace -f -e trace=sendto,recvfrom,connect,accept ./udp_server &
SERVER_PID=$!
echo "UDP сервер запущен (PID: $SERVER_PID)"

# Даем серверу время на запуск
sleep 2

# Запуск клиента
echo -e "\nЗапуск UDP клиента..."
strace -f -e trace=sendto,recvfrom,connect,accept  ./udp_client


# Остановка сервера и очистка
kill $SERVER_PID 2>/dev/null
rm udp_server udp_client 