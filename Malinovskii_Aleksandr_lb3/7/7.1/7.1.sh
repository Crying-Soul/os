#!/bin/bash

# =============================================================================
# Скрипт для компиляции и запуска сетевого клиента
# =============================================================================
# Цель:
#   Компиляция и запуск программ "server.c" и "client.c", а также анализ их
#   работы с использованием `strace`.  Скрипт предназначен для демонстрации
#   основ сетевого взаимодействия, в частности, соединения TCP клиента с
#   сервером.
#
# Описание:
#   Скрипт выполняет следующие действия:
#     1. Компилирует исходные файлы "server.c" и "client.c" в исполняемые
#        файлы "server" и "client".
#     2. Запускает сервер в фоновом режиме, перенаправляя вывод `strace` в
#        файл "server.log".
#     3. Запускает клиент, перенаправляя вывод `strace` в файл "client.log".
#     4. Выводит содержимое файлов "server.log" и "client.log" на экран.
#     5. Завершает работу сервера.
#
# Используемые инструменты:
#   - `gcc`: Компилятор C.
#   - `strace`: Утилита для трассировки системных вызовов.
#   - `kill`: Утилита для завершения процессов.
#   - `cat`: Утилита для вывода содержимого файлов.
#
# Трассируемые системные вызовы:
#   - `sendto`: Отправка данных по сокету.
#   - `recvfrom`: Получение данных по сокету.
#   - `connect`: Установление соединения с сервером (для клиента).
#   - `accept`: Принятие входящего соединения (для сервера).
#
# Параметры:
#   Нет. Скрипт не принимает аргументов командной строки.
#
# Зависимости:
#   - gcc
#   - strace
#
# Вывод:
#   Скрипт выводит сообщения о ходе выполнения, а также содержимое файлов
#   "server.log" и "client.log", содержащих трассировку системных вызовов.
#
# Примечания:
#   - Перед запуском скрипта убедитесь, что у вас есть исходные файлы
#     "server.c" и "client.c" в текущем каталоге.
#   - Скрипт предполагает, что сервер слушает на localhost и на стандартном
#     порту (определён в коде "server.c").
#   - Для более подробного анализа системных вызовов можно изменить параметры
#     `strace`.
# =============================================================================


cd 7/7.1
echo "=============================================="
echo "                  ЗАДАНИЕ 7.1                 "
echo "=============================================="
# Компиляция
gcc server.c -o server && gcc client.c -o client
chmod +x server client

# Запуск сервера в фоне с перенаправлением вывода
strace -f -e trace=sendto,recvfrom,connect,accept ./server > server.log 2>&1 &
SERVER_PID=$!
echo "Сервер запущен (PID: $SERVER_PID)"

# Ждем запуска сервера
sleep 2

# Запуск клиента
echo -e "\nЗапуск клиента..."
strace -f -e trace=sendto,recvfrom,connect,accept ./client > client.log 2>&1

# Вывод логов
echo -e "\n=== Вывод сервера ==="
cat server.log

echo -e "\n=== Вывод клиента ==="
cat client.log

# Очистка
kill $SERVER_PID 2>/dev/null
rm server client server.log client.log