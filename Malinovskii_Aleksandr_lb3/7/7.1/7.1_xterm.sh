#!/bin/bash

# =============================================================================
# Скрипт для демонстрации TCP-сокетов с использованием xterm
# =============================================================================
# Цель:
#   Компиляция и запуск TCP-сервера и клиента в отдельных окнах xterm для
#   демонстрации сетевого взаимодействия.
#
# Описание:
#   Скрипт выполняет следующие действия:
#     1. Компилирует исходные файлы "server.c" и "client.c" в исполняемые
#        файлы "server" и "client".
#     2. Запускает сервер в отдельном окне xterm.
#     3. Запускает клиент в отдельном окне xterm.
#     4. Ожидает завершения работы клиента.
#     5. Завершает работу сервера.
#
# Используемые инструменты:
#   - `gcc`: Компилятор C.
#   - `xterm`: Эмулятор терминала X Window System.
#   - `kill`: Утилита для завершения процессов.
#   - `chmod`: Утилита для изменения прав доступа к файлам.
#
# Зависимости:
#   - gcc
#   - xterm
#
# Параметры:
#   Нет. Скрипт не принимает аргументов командной строки.
#
# Вывод:
#   Скрипт выводит сообщения о ходе выполнения в текущем терминале, а также
#   открывает два отдельных окна xterm для работы сервера и клиента.
#
# Примечания:
#   - Перед запуском скрипта убедитесь, что у вас установлены xterm и gcc.
#   - Скрипт предполагает, что исходные файлы "server.c" и "client.c" находятся
#     в том же каталоге, что и скрипт.
#   - Убедитесь, что сервер и клиент настроены на взаимодействие по localhost
#     и определенному порту.
# =============================================================================


# Файлы программ
SERVER_SRC="server.c"
CLIENT_SRC="client.c"
SERVER_BIN="server"
CLIENT_BIN="client"

# Функция для компиляции
compile_programs() {
    echo "Компиляция сервера..."
    if ! gcc "$SERVER_SRC" -o "$SERVER_BIN"; then
        echo "Ошибка компиляции сервера!"
        exit 1
    fi
    
    echo "Компиляция клиента..."
    if ! gcc "$CLIENT_SRC" -o "$CLIENT_BIN"; then
        echo "Ошибка компиляции клиента!"
        exit 1
    fi
    
    echo "Компиляция завершена успешно."
    chmod +x "$SERVER_BIN" "$CLIENT_BIN"
}

# Функция для запуска программ
run_programs() {
    # Проверяем наличие xterm
    if ! command -v xterm &> /dev/null; then
        echo "Ошибка: xterm не установлен. Установите его или модифицируйте скрипт для использования другого терминала."
        exit 1
    fi
    
    # Запускаем сервер в одном терминале
    xterm -hold -title "TCP Сервер" -e "./$SERVER_BIN" &
    SERVER_PID=$!
    echo "Сервер запущен (PID: $SERVER_PID)"
    
    # Даем серверу время на запуск
    sleep 2
    
    # Запускаем клиент в другом терминале
    xterm -hold -title "TCP Клиент" -e "./$CLIENT_BIN" &
    CLIENT_PID=$!
    echo "Клиент запущен (PID: $CLIENT_PID)"
    
    # Ждем завершения клиента
    wait $CLIENT_PID
    
    # Даем серверу время обработать соединение
    sleep 1
    
    # Завершаем сервер
    kill $SERVER_PID 2>/dev/null
    echo "Сервер остановлен."
}

# Основной код
clear
echo "=== Демонстрация TCP-сокетов на C ==="

# Компилируем программы
compile_programs

# Запускаем программы
echo -e "\nЗапуск сервера и клиента..."
run_programs

echo -e "\nДемонстрация завершена."
exit 0